# Design Notes: Semantic Retrieval

## Core Principles

- **Backend agnostic**: no hard dependency on vector stores.
- **Composable scoring**: support BM25-only, vector-only, and hybrid.
- **Deterministic ranking**: stable tie-breakers for reproducible results.
- **Separation of concerns**: indexing vs searching are distinct interfaces.

## Indexing

- Tool documents include namespace, name, description, tags, and schema hints.
- Embeddings are generated by a caller-supplied `Embedder`.

## Querying

- Query text is embedded and compared to tool documents.
- Optional filters (namespace, tags, category) are applied post-score.

## Integration Points

- `toolindex`: source of tool documents.
- `toolsearch`: optional BM25 implementation for baseline ranking.
- `metatools-mcp`: provider layer can call semantic search.

## Interface Contracts

### Indexer

- **Concurrency:** implementations are safe for concurrent use.
- **Context:** methods honor cancellation/deadlines where applicable.
- **Errors:** invalid IDs return `ErrInvalidDocumentID`.
- **Determinism:** `List` returns stable ordering.

### Searcher

- **Concurrency:** implementations are safe for concurrent use.
- **Context:** methods honor cancellation/deadlines.
- **Determinism:** ordering is stable for identical inputs.

### Strategy / BM25Scorer / Embedder

- **Concurrency:** implementations are safe for concurrent use.
- **Context:** `Embed`/`Score` honor cancellation/deadlines.
- **Determinism:** identical inputs yield stable scores.
